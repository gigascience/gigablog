#!/bin/bash

# Generated by chef. Don't ****ing touch!
# - unless you're editing the template (db_backup.erb) -

directory_name="<%= node[:gigablog][:vagrant_dir] %>/backups"

if [ -d $directory_name ]
then
    echo "Directory already exists"
else
   sudo mkdir -p $directory_name
   chown -R centos:admin $directory_name
fi

# Create name for file
filename=$directory_name"/"$(date +%Y%m%d)"_gigablog_wp_db.sql"
s3_prefix="s3://gigablog-backups/"
s3filename=$s3_prefix$(date +%Y%m%d)".sql"

# Generate database SQL dump
mysqldump -u root --password=<%= node[:wordpress][:db][:root_password] %> <%= node[:wordpress][:db][:name] %> > $filename

# Copy backup file to S3 and log output and errors
aws s3 cp $filename $s3filename >> <%= node[:gigablog][:vagrant_dir] %>/log/aws.log 2>&1

# Also need backup of wordpress directory
wp_dir = "/var/www/wordpress"

zip_filename = $(date +%Y%m%d)"_gigablog_wp.tar.gz"
s3filename=$s3_prefix$(date +%Y%m%d)"_gigablog_wp.tar.gz"

# Compress files
tar -cvzf $directory_name"/"$zip_filename wp_dir

# Copy database backup file to S3 and log output and errors
aws s3 cp $zip_filename $s3filename >> <%= node[:gigablog][:vagrant_dir] %>/log/aws.log 2>&1